# QA Loop - å®Œæ•´ä½¿ç”¨æŒ‡å—

**æ—¥æœŸ**: 2026-01-18  
**çŠ¶æ€**: âœ… å·²å°±ç»ª

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
cd "/Users/puyijun/Downloads/authentication-flow-design (1)"
pnpm qa:loop
```

**è¿™ä¸ªå‘½ä»¤ä¼šåšä»€ä¹ˆ**:

1. è‡ªåŠ¨æ¸…ç†æ—§çš„å¼€å‘æœåŠ¡å™¨
2. å¯åŠ¨æ–°çš„å¼€å‘æœåŠ¡å™¨
3. æµ‹è¯•å…³é”®ç«¯ç‚¹
4. å¼•å¯¼ä½ æ‰‹åŠ¨ç™»å½• 2 æ¬¡ï¼ˆFan + Creatorï¼‰
5. è¿è¡Œå®Œæ•´çš„ç«™ç‚¹å®¡è®¡ï¼ˆ60 ä¸ªåœºæ™¯ï¼‰
6. ç”ŸæˆæŠ¥å‘Šå’Œæˆªå›¾
7. è‡ªåŠ¨æ¸…ç†å¹¶ä¿å­˜æ—¥å¿—

**æ€»æ—¶é•¿**: 5-10 åˆ†é’Ÿ

---

## ğŸ“‹ ä½ éœ€è¦åšçš„äº‹

### å”¯ä¸€çš„æ‰‹åŠ¨æ­¥éª¤ï¼šç™»å½• 2 æ¬¡

è„šæœ¬ä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ 2 æ¬¡ï¼Œä½ åªéœ€è¦ï¼š

#### ç¬¬ 1 æ¬¡ï¼šFan ç™»å½•

1. æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€åˆ° http://127.0.0.1:3000/auth
2. è¾“å…¥ï¼š
   - Email: `fan@test.com`
   - Password: `TestFan123!`
3. ç‚¹å‡» "Sign In"
4. ç­‰å¾…æµè§ˆå™¨è‡ªåŠ¨å…³é—­ï¼ˆçº¦ 5 ç§’ï¼‰

#### ç¬¬ 2 æ¬¡ï¼šCreator ç™»å½•

1. æµè§ˆå™¨å†æ¬¡æ‰“å¼€
2. è¾“å…¥ï¼š
   - Email: `creator@test.com`
   - Password: `TestCreator123!`
3. ç‚¹å‡» "Sign In"
4. ç­‰å¾…æµè§ˆå™¨è‡ªåŠ¨å…³é—­

**å°±è¿™ä¹ˆç®€å•ï¼å‰©ä¸‹çš„å…¨è‡ªåŠ¨ã€‚**

---

## ğŸ¯ Pipeline æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: æ¸…ç†çŠ¶æ€                                         â”‚
â”‚ - æ€æ­»æ—§çš„ dev æœåŠ¡å™¨                                     â”‚
â”‚ - åˆ é™¤ .next/dev/lock                                    â”‚
â”‚ - åˆ›å»º artifacts ç›®å½•                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: å¯åŠ¨å¼€å‘æœåŠ¡å™¨                                   â”‚
â”‚ - pnpm dev (åå°)                                        â”‚
â”‚ - ç­‰å¾… /auth è¿”å› 200/307/302                            â”‚
â”‚ - è¶…æ—¶æ—¶é—´: 60 ç§’                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: å†’çƒŸæµ‹è¯•                                         â”‚
â”‚ - æµ‹è¯• /api/tags?category=content                       â”‚
â”‚ - å¿…é¡»è¿”å› 200 æˆ– 401                                    â”‚
â”‚ - å¦‚æœ 500/404: æ‰“å°æ—¥å¿—å¹¶é€€å‡º                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: å¯¼å‡ºä¼šè¯ (éœ€è¦æ‰‹åŠ¨ç™»å½•)                          â”‚
â”‚ - å¯¼å‡º Fan ä¼šè¯   â†’ ä½ ç™»å½• fan@test.com                 â”‚
â”‚ - å¯¼å‡º Creator ä¼šè¯ â†’ ä½ ç™»å½• creator@test.com           â”‚
â”‚ - éªŒè¯ .json æ–‡ä»¶å­˜åœ¨                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: å®Œæ•´å®¡è®¡                                         â”‚
â”‚ - æµ‹è¯• 20 è·¯ç”± Ã— 3 çŠ¶æ€ = 60 åœºæ™¯                        â”‚
â”‚ - ç”Ÿæˆ 60 å¼ æˆªå›¾                                         â”‚
â”‚ - éªŒè¯ Fan/Creator ä¼šè¯æœ‰æ•ˆ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: æœ€ç»ˆéªŒè¯                                         â”‚
â”‚ - æ£€æŸ¥æ‰€æœ‰é¢„æœŸæ–‡ä»¶å­˜åœ¨                                    â”‚
â”‚ - æ‰“å°æ–‡ä»¶åˆ—è¡¨                                           â”‚
â”‚ - æ˜¾ç¤º summary.json                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
                    âœ… å®Œæˆï¼
```

---

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

### æˆåŠŸè¾“å‡º

```bash
============================================================
STEP 1: Ensure clean state
============================================================
[INFO] Checking for existing dev servers on port 3000...
[âœ“] Port 3000 is free
[âœ“] No stale lock files
[âœ“] Artifacts directory ready: /path/to/artifacts/qa

============================================================
STEP 2: Start dev server
============================================================
[INFO] Starting dev server on port 3000...
[INFO] Dev server started (PID: 12345)
[INFO] Waiting for server to be ready...
[âœ“] Server is ready! (5s)

============================================================
STEP 3: Smoke-check blocker endpoint
============================================================
[INFO] Testing: http://127.0.0.1:3000/api/tags?category=content
[âœ“] Endpoint returned HTTP 401 (OK)

============================================================
STEP 4: Export sessions
============================================================
[INFO] Note: This step requires MANUAL LOGIN in the browser
[INFO] Please login when prompted:
[INFO]   Fan: fan@test.com / TestFan123!
[INFO]   Creator: creator@test.com / TestCreator123!

[INFO] Exporting fan session...
ğŸ” Manual Login Session Export
... (æµè§ˆå™¨æ‰“å¼€ï¼Œä½ ç™»å½•)
âœ… SUCCESS
[âœ“] Fan session exported: artifacts/agent-browser-full/sessions/fan.json

[INFO] Exporting creator session...
... (æµè§ˆå™¨å†æ¬¡æ‰“å¼€ï¼Œä½ ç™»å½•)
âœ… SUCCESS
[âœ“] Creator session exported: artifacts/agent-browser-full/sessions/creator.json

============================================================
STEP 5: Run full audit
============================================================
[INFO] Running full site audit...
ğŸ” Full Site Interactive Audit
Testing as: ANONYMOUS
Testing as: FAN
Testing as: CREATOR
[âœ“] Full audit completed successfully

============================================================
STEP 6: Final verification
============================================================
[INFO] Checking generated files...
[âœ“] All expected files present

[INFO] Generated files:

Sessions:
-rw-r--r--  fan.json
-rw-r--r--  creator.json
-rw-r--r--  fan-post-login.png
-rw-r--r--  creator-post-login.png

Audit artifacts:
-rw-r--r--  summary.json
-rw-r--r--  audit-results.json

[INFO] Audit Summary (summary.json):
{
  "timestamp": "2026-01-18T...",
  "totalTests": 60,
  "successfulLoads": 60,
  "passRate": "100.0%",
  "sessionsValid": true,
  "fanAuthPageRatio": "0.0%",
  "creatorAuthPageRatio": "5.0%"
}

============================================================
âœ… QA LOOP COMPLETE
============================================================
[âœ“] All checks passed!
[INFO] Server log saved to: artifacts/qa/server.log
[INFO] Artifacts saved to: artifacts/qa
```

### å¤±è´¥è¾“å‡ºï¼ˆç¤ºä¾‹ï¼‰

```bash
============================================================
STEP 3: Smoke-check blocker endpoint
============================================================
[INFO] Testing: http://127.0.0.1:3000/api/tags?category=content
[âœ—] Endpoint returned HTTP 500 (expected 200 or 401)
[âœ—] Last 80 lines of server log:
Error: Cannot read property 'map' of undefined
    at /app/api/tags/route.ts:15:20
...
```

**è„šæœ¬ä¼šç«‹å³é€€å‡ºï¼Œä¸ä¼šç»§ç»­æ‰§è¡Œã€‚**

---

## ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶

```
artifacts/
â”œâ”€â”€ qa/
â”‚   â””â”€â”€ server.log                              # å¼€å‘æœåŠ¡å™¨æ—¥å¿—
â””â”€â”€ agent-browser-full/
    â”œâ”€â”€ sessions/
    â”‚   â”œâ”€â”€ fan.json                            # Fan ä¼šè¯çŠ¶æ€
    â”‚   â”œâ”€â”€ creator.json                        # Creator ä¼šè¯çŠ¶æ€
    â”‚   â”œâ”€â”€ fan-post-login.png                  # Fan éªŒè¯æˆªå›¾
    â”‚   â””â”€â”€ creator-post-login.png              # Creator éªŒè¯æˆªå›¾
    â”œâ”€â”€ summary.json                            # å®¡è®¡æ‘˜è¦
    â”œâ”€â”€ audit-results.json                      # è¯¦ç»†å®¡è®¡ç»“æœ
    â”œâ”€â”€ anonymous/
    â”‚   â”œâ”€â”€ home.png
    â”‚   â”œâ”€â”€ auth.png
    â”‚   â””â”€â”€ ... (20 å¼ æˆªå›¾)
    â”œâ”€â”€ fan/
    â”‚   â”œâ”€â”€ home.png
    â”‚   â”œâ”€â”€ me-wallet.png
    â”‚   â””â”€â”€ ... (20 å¼ æˆªå›¾)
    â””â”€â”€ creator/
        â”œâ”€â”€ home.png
        â”œâ”€â”€ creator-new-post.png
        â””â”€â”€ ... (20 å¼ æˆªå›¾)
```

**æ€»è®¡**: ~65 ä¸ªæ–‡ä»¶

---

## ğŸ”§ æ•…éšœæ’é™¤

### é—®é¢˜ 1: "Port 3000 already in use"

**åŸå› **: æœ‰å…¶ä»–è¿›ç¨‹å ç”¨ç«¯å£

**è§£å†³**:

```bash
lsof -ti:3000 | xargs kill -9
pnpm qa:loop
```

### é—®é¢˜ 2: "Server failed to start within 60s"

**åŸå› **: å¼€å‘æœåŠ¡å™¨å¯åŠ¨å¤±è´¥

**è§£å†³**:

1. æŸ¥çœ‹æ—¥å¿—: `cat artifacts/qa/server.log`
2. æ£€æŸ¥ä¾èµ–: `pnpm install`
3. æ¸…ç†ç¼“å­˜: `rm -rf .next && pnpm dev`

### é—®é¢˜ 3: "Failed to export fan session"

**åŸå› **: ç™»å½•è¶…æ—¶æˆ–è´¦æˆ·ä¸å­˜åœ¨

**è§£å†³**:

1. ç¡®ä¿æµ‹è¯•è´¦æˆ·å­˜åœ¨:
   ```bash
   pnpm exec tsx scripts/auth/create-test-accounts.ts
   ```
2. é‡æ–°è¿è¡Œ: `pnpm qa:loop`
3. ç™»å½•æ—¶åŠ¨ä½œå¿«ä¸€ç‚¹ï¼ˆ2 åˆ†é’Ÿå†…å®Œæˆï¼‰

### é—®é¢˜ 4: "Audit output missing 'Testing as: FAN'"

**åŸå› **: ä¼šè¯æ–‡ä»¶æœªæ­£ç¡®åŠ è½½

**è§£å†³**:

1. åˆ é™¤æ—§ä¼šè¯:
   ```bash
   rm -rf artifacts/agent-browser-full/sessions/*
   ```
2. é‡æ–°è¿è¡Œ: `pnpm qa:loop`

### é—®é¢˜ 5: "Endpoint returned HTTP 500"

**åŸå› **: åç«¯ä»£ç æœ‰ bug

**è§£å†³**:

1. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼ˆè„šæœ¬ä¼šè‡ªåŠ¨æ‰“å°ï¼‰
2. ä¿®å¤ä»£ç 
3. é‡æ–°è¿è¡Œ: `pnpm qa:loop`

---

## ğŸ§¹ æ¸…ç†

è„šæœ¬ä¼šè‡ªåŠ¨æ¸…ç†ï¼š

- âœ… åœæ­¢å¼€å‘æœåŠ¡å™¨ï¼ˆtrap EXITï¼‰
- âœ… æ€æ­»ç«¯å£ 3000 ä¸Šçš„è¿›ç¨‹
- âœ… ä¿å­˜æœåŠ¡å™¨æ—¥å¿—

**å¦‚æœè„šæœ¬å´©æºƒï¼Œæ‰‹åŠ¨æ¸…ç†**:

```bash
lsof -ti:3000 | xargs kill -9
rm -f .next/dev/lock
```

---

## âš¡ æ€§èƒ½

- **é¦–æ¬¡è¿è¡Œ**: 5-10 åˆ†é’Ÿï¼ˆåŒ…æ‹¬æ‰‹åŠ¨ç™»å½•ï¼‰
- **åç»­è¿è¡Œ**: 3-5 åˆ†é’Ÿï¼ˆå¦‚æœä¼šè¯å·²å­˜åœ¨ï¼‰
- **æœåŠ¡å™¨å¯åŠ¨**: 5-15 ç§’
- **å®Œæ•´å®¡è®¡**: 2-3 åˆ†é’Ÿï¼ˆ60 ä¸ªè·¯ç”±ï¼‰

---

## ğŸ“ é«˜çº§ç”¨æ³•

### è·³è¿‡ä¼šè¯å¯¼å‡ºï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰

ä¿®æ”¹ `scripts/qa/loop.sh` çš„æ­¥éª¤ 4:

```bash
if [ -f "$FAN_SESSION" ] && [ -f "$CREATOR_SESSION" ]; then
  log_info "Sessions already exist, skipping export"
else
  # ... åŸæœ‰çš„å¯¼å‡ºé€»è¾‘
fi
```

### ä»…è¿è¡Œå®¡è®¡ï¼ˆå‡è®¾ä¼šè¯å·²å­˜åœ¨ï¼‰

```bash
pnpm audit:full
```

### ä»…å¯¼å‡ºä¼šè¯

```bash
pnpm test:session:export:fan
pnpm test:session:export:creator
```

---

## ğŸ“ éªŒæ”¶æ¸…å•

è¿è¡Œ `pnpm qa:loop` åï¼ŒéªŒè¯ï¼š

- [ ] è„šæœ¬é€€å‡ºç ä¸º 0
- [ ] è¾“å‡ºåŒ…å« "âœ… QA LOOP COMPLETE"
- [ ] `artifacts/qa/server.log` å­˜åœ¨
- [ ] `artifacts/agent-browser-full/sessions/fan.json` å­˜åœ¨
- [ ] `artifacts/agent-browser-full/sessions/creator.json` å­˜åœ¨
- [ ] `artifacts/agent-browser-full/summary.json` å­˜åœ¨
- [ ] `summary.json` ä¸­ `sessionsValid: true`
- [ ] `summary.json` ä¸­ `fanAuthPageRatio` < 5%
- [ ] `summary.json` ä¸­ `creatorAuthPageRatio` < 5%

---

## ğŸš€ ç°åœ¨å°±è¯•è¯•

```bash
cd "/Users/puyijun/Downloads/authentication-flow-design (1)"
pnpm qa:loop
```

**å‡†å¤‡å¥½ç™»å½• 2 æ¬¡ï¼Œç„¶ååä¸‹æ¥çœ‹å®ƒè¿è¡Œï¼**

---

**æœ€åæ›´æ–°**: 2026-01-18
