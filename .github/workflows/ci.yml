name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10"

jobs:
  # ============================================
  # Stage 1: Code Quality
  # ============================================
  lint-and-type-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies (locked)
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Run TypeScript type check
        run: pnpm type-check

  # ============================================
  # Stage 2: Build Verification (must pass before QA gate / E2E)
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    timeout-minutes: 20
    env:
      CI: true
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies (locked)
        run: pnpm install --frozen-lockfile

      - name: Build application (production)
        run: pnpm build

  # ============================================
  # Stage 3: QA Gate (UI Gate + Dead Click Gate)
  # Runs pnpm qa:gate and uploads artifacts/qa
  # ============================================
  qa-gate:
    name: QA Gate (ui + deadclick)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 25
    env:
      CI: true
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_TEST_MODE: "true"
      # Used by scripts if needed
      PLAYWRIGHT_BASE_URL: "http://127.0.0.1:3000"
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies (locked)
        run: pnpm install --frozen-lockfile

      # If your qa:gate starts the app itself, you may not need pnpm build.
      # Keeping build here is safer for Next apps and avoids missing .next in CI.
      - name: Build application (required for QA gate, if applicable)
        run: pnpm build

      # If your qa:gate uses Playwright, this avoids missing browser deps.
      - name: Install Playwright (with deps) - Chromium
        run: pnpm exec playwright install --with-deps chromium

      - name: Start app server (background)
        run: |
          PORT=3000 pnpm start > .next/qa-server.log 2>&1 &
          echo $! > .next/qa-server.pid

      - name: Wait for health endpoint
        run: |
          for i in {1..30}; do
            if curl -sf "http://127.0.0.1:3000/api/health" > /dev/null; then
              echo "‚úÖ Server is ready"
              exit 0
            fi
            sleep 2
          done
          echo "‚ùå Server did not become ready in time"
          exit 1

      - name: Create test users (if needed)
        run: |
          echo "üîß Creating test users for QA gate..."
          pnpm tsx scripts/create-test-users.ts || echo "‚ö†Ô∏è  Test users may already exist, continuing..."

      - name: Create test sessions
        run: |
          echo "üîê Creating test sessions for QA gate..."
          echo "Running: pnpm test:session:auto:all"
          pnpm test:session:auto:all || {
            echo "‚ùå Session creation failed"
            echo "Checking if session files exist..."
            ls -la artifacts/agent-browser-full/sessions/ || echo "Sessions directory does not exist"
            exit 1
          }
          echo "‚úÖ Session creation completed"
          echo "Verifying session files..."
          ls -la artifacts/agent-browser-full/sessions/ || echo "‚ö†Ô∏è  No session files found"

      - name: Run QA Gate
        run: pnpm qa:gate

      - name: Stop app server
        if: always()
        run: |
          if [ -f .next/qa-server.pid ]; then
            kill $(cat .next/qa-server.pid) || true
          fi

      - name: Upload QA artifacts (artifacts/qa)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-artifacts
          path: artifacts/qa/
          retention-days: 14

  # ============================================
  # Stage 4: E2E Tests (CI-first, production server managed by Playwright webServer)
  # IMPORTANT:
  # - Do NOT start server manually here.
  # - Playwright webServer (in playwright.config.ts) will start pnpm start in CI.
  # - We build again in this job to ensure .next exists in the same runner.
  # ============================================
  e2e-tests:
    name: E2E Tests (chromium)
    runs-on: ubuntu-latest
    needs: [build, qa-gate]
    timeout-minutes: 35
    env:
      CI: true
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_TEST_MODE: "true"
      # Used by playwright.config.ts
      PLAYWRIGHT_BASE_URL: "http://127.0.0.1:3000"
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies (locked)
        run: pnpm install --frozen-lockfile

      - name: Build application (required for pnpm start)
        run: pnpm build

      - name: Install Playwright (with deps) - Chromium
        run: pnpm exec playwright install --with-deps chromium

      - name: Run E2E (chromium)
        run: pnpm exec playwright test --project=chromium --reporter=html

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload Playwright traces (test-results)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 14

  # ============================================
  # Stage 6: Quality Gate
  # ============================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, build, qa-gate, e2e-tests]
    timeout-minutes: 5
    steps:
      - name: Summary
        run: |
          echo "‚úÖ Lint & Type Check: Passed"
          echo "‚úÖ Build: Passed"
          echo "‚úÖ QA Gate (ui+deadclick): Passed"
          echo "‚úÖ E2E (Chromium): Passed"
          echo "üöÄ Ready for deployment!"
