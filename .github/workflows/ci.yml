name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "10"

jobs:
  # ============================================
  # Stage 1: Code Quality
  # ============================================
  lint-and-type-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies (locked)
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint

      - name: Run TypeScript type check
        run: pnpm type-check

  # ============================================
  # Stage 2: Build Verification (must pass before QA gate / E2E)
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint-and-type-check
    timeout-minutes: 20
    env:
      CI: true
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies (locked)
        run: pnpm install --frozen-lockfile

      - name: Build application (production)
        run: pnpm build

  # ============================================
  # Stage 3: QA Gate (UI Gate + Dead Click Gate)
  # Runs pnpm qa:gate and uploads artifacts/qa
  # ============================================
  qa-gate:
    name: QA Gate (ui + deadclick)
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 25
    env:
      CI: true
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_TEST_MODE: "true"
      # ç»Ÿä¸€æµ‹è¯•å¼€å…³ï¼š/api/test/* è·¯ç”± gate ä¾èµ– E2E æˆ– PLAYWRIGHT_TEST_MODE
      PLAYWRIGHT_TEST_MODE: "true"
      E2E: "1"
      # Used by scripts if needed
      PLAYWRIGHT_BASE_URL: "http://127.0.0.1:3000"
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies (locked)
        run: pnpm install --frozen-lockfile

      # If your qa:gate starts the app itself, you may not need pnpm build.
      # Keeping build here is safer for Next apps and avoids missing .next in CI.
      - name: Build application (required for QA gate, if applicable)
        run: pnpm build

      # If your qa:gate uses Playwright, this avoids missing browser deps.
      - name: Install Playwright (with deps) - Chromium
        run: pnpm exec playwright install --with-deps chromium

      - name: Start app server (background)
        run: |
          PORT=3000 pnpm start > .next/qa-server.log 2>&1 &
          echo $! > .next/qa-server.pid

      - name: Wait for health endpoint
        run: |
          for i in {1..30}; do
            if curl -sf "http://127.0.0.1:3000/api/health" > /dev/null; then
              echo "âœ… Server is ready"
              exit 0
            fi
            sleep 2
          done
          echo "âŒ Server did not become ready in time"
          exit 1

      - name: Test-mode sanity check (must not 404)
        run: |
          # 1) /api/test/ping must return 200
          PING_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:3000/api/test/ping")
          if [ "$PING_CODE" != "200" ]; then
            echo "âŒ /api/test/ping returned $PING_CODE (expected 200) â€” test-mode NOT enabled"
            echo "   PLAYWRIGHT_TEST_MODE=$PLAYWRIGHT_TEST_MODE NEXT_PUBLIC_TEST_MODE=$NEXT_PUBLIC_TEST_MODE E2E=$E2E"
            exit 1
          fi
          echo "âœ… /api/test/ping => 200"
          # 2) /api/test/session route exists (HEAD only, no signIn)
          SESSION_CODE=$(curl -s -o /dev/null -w "%{http_code}" -I "http://127.0.0.1:3000/api/test/session")
          if [ "$SESSION_CODE" = "404" ]; then
            echo "âŒ /api/test/session returned 404 â€” session route not enabled"
            exit 1
          fi
          echo "âœ… /api/test/session route reachable (HEAD => $SESSION_CODE, 405/400 ok)"

      - name: Create test users (if needed)
        run: |
          echo "ðŸ”§ Creating test users for QA gate..."
          pnpm tsx scripts/create-test-users.ts || echo "âš ï¸  Test users may already exist, continuing..."

      - name: Create test sessions
        run: |
          echo "ðŸ” Creating test sessions for QA gate..."
          echo "Running: pnpm test:session:auto:all"
          pnpm test:session:auto:all || {
            echo "âŒ Session creation failed"
            echo "Checking if session files exist..."
            ls -la artifacts/agent-browser-full/sessions/ || echo "Sessions directory does not exist"
            exit 1
          }
          echo "âœ… Session creation completed"
          echo "Verifying session files..."
          ls -la artifacts/agent-browser-full/sessions/
          for f in fan.json creator.json; do
            if [ ! -f "artifacts/agent-browser-full/sessions/$f" ]; then
              echo "âŒ Missing session file: $f"
              exit 1
            fi
          done
          echo "âœ… fan.json and creator.json present"

      - name: QA Gate - Check server
        run: bash scripts/qa/check-server.sh

      - name: QA Gate - UI (gate-ui)
        run: pnpm test:gate:ui

      - name: QA Gate - Dead Click (gate-deadclick)
        run: pnpm test:gate:deadclick

      - name: QA Gate - Full site audit (audit:full)
        run: pnpm audit:full

      - name: Stop app server
        if: always()
        run: |
          if [ -f .next/qa-server.pid ]; then
            kill $(cat .next/qa-server.pid) || true
          fi

      - name: Upload QA artifacts (artifacts/qa)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-artifacts
          path: artifacts/qa/
          retention-days: 14

  # ============================================
  # Stage 4: E2E Tests (CI-first, production server managed by Playwright webServer)
  # IMPORTANT:
  # - Do NOT start server manually here.
  # - Playwright webServer (in playwright.config.ts) will start pnpm start in CI.
  # - We build again in this job to ensure .next exists in the same runner.
  # ============================================
  e2e-tests:
    name: E2E Tests (chromium)
    runs-on: ubuntu-latest
    needs: [build, qa-gate]
    timeout-minutes: 35
    env:
      CI: true
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      NEXT_PUBLIC_TEST_MODE: "true"
      # ç»Ÿä¸€æµ‹è¯•å¼€å…³ï¼š/api/test/sessionã€/api/test/create-post-with-media ä¾èµ–
      PLAYWRIGHT_TEST_MODE: "true"
      E2E: "1"
      # Used by playwright.config.ts
      PLAYWRIGHT_BASE_URL: "http://127.0.0.1:3000"
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies (locked)
        run: pnpm install --frozen-lockfile

      - name: Build application (required for pnpm start)
        run: pnpm build

      - name: Install Playwright (with deps) - Chromium
        run: pnpm exec playwright install --with-deps chromium

      - name: Start app server (background)
        run: |
          PORT=3000 pnpm start > .next/e2e-server.log 2>&1 &
          echo $! > .next/e2e-server.pid

      - name: Wait for health and test-mode
        run: |
          for i in {1..30}; do
            if curl -sf "http://127.0.0.1:3000/api/health" > /dev/null; then
              echo "âœ… Server is ready"
              break
            fi
            sleep 2
          done
          if ! curl -sf "http://127.0.0.1:3000/api/health" > /dev/null; then
            echo "âŒ Server did not become ready in time"
            exit 1
          fi
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://127.0.0.1:3000/api/test/ping")
          if [ "$CODE" != "200" ]; then
            echo "âŒ /api/test/ping returned $CODE (expected 200) â€” test-mode is NOT enabled"
            echo "   PLAYWRIGHT_TEST_MODE=$PLAYWRIGHT_TEST_MODE E2E=$E2E PLAYWRIGHT_BASE_URL=$PLAYWRIGHT_BASE_URL"
            exit 1
          fi
          echo "âœ… Test-mode sanity check passed (ping=200)"

      - name: Run E2E (chromium)
        env:
          PLAYWRIGHT_SKIP_SERVER: "true"
        run: pnpm exec playwright test --project=chromium --reporter=html

      - name: Stop app server
        if: always()
        run: |
          if [ -f .next/e2e-server.pid ]; then
            kill $(cat .next/e2e-server.pid) 2>/dev/null || true
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 14

      - name: Upload Playwright traces (test-results)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-traces
          path: test-results/
          retention-days: 14

      - name: Upload e2e server log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-server-log
          path: .next/e2e-server.log
          retention-days: 14
          if-no-files-found: ignore

  # ============================================
  # Stage 6: Quality Gate
  # ============================================
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [lint-and-type-check, build, qa-gate, e2e-tests]
    timeout-minutes: 5
    steps:
      - name: Summary
        run: |
          echo "âœ… Lint & Type Check: Passed"
          echo "âœ… Build: Passed"
          echo "âœ… QA Gate (ui+deadclick): Passed"
          echo "âœ… E2E (Chromium): Passed"
          echo "ðŸš€ Ready for deployment!"
