---
description: RELEASE GATE - Supreme Law for Repair, Verification, CI Readiness, and Production Consistency.
scope: GLOBAL
priority: ABSOLUTE
version: 1.0.0
alwaysApply: true
---

# 🚨 RELEASE GATE SUPREME LAW (v1.0)

All CI checks are subordinate to RELEASE GATE SUPREME LAW.

This document is the **highest authority** in this repository.
All rules, agents, skills, scripts, and fixes MUST comply.

Violation = REFUSE TO PROCEED.

---

## 0. PRIME DIRECTIVE (不可违背)

🎯 **唯一目标**：
> The codebase MUST be pushable to CI with **100% pass**, and behave **identically** in:
- Local dev
- CI
- Production (Vercel)

If this cannot be proven → STOP.

---

## 1. PLAN OR REFUSE (取代 sprint 文档缺失)

If no planning doc exists:
- The agent MUST generate a **temporary execution plan**
- Save it to:

docs/planning/_auto/<timestamp>-release-plan.md

Plan MUST include:
- Scope
- Affected files
- Tests to run
- CI checks involved

❌ No plan → No code.

---

## 2. MULTI-AGENT MANDATORY PIPELINE

Every repair / refactor / CI fix MUST dispatch agents **in this order**:

### Stage 1 — SYSTEM SCAN
Agents:
- `chief-ai-automation`
- `chief-reliability`
- `chief-quality`

Goals:
- Detect hidden failures
- Detect CI mismatch
- Detect flakiness risks

---

### Stage 2 — DOMAIN OWNERSHIP
Dispatch **by problem type**:

| Problem | Agent |
|------|------|
| Auth / Supabase | `chief-backend-platform` |
| UI / test selectors | `chief-frontend` |
| E2E failures | `chief-quality` |
| CI / env / ports | `chief-reliability` |
| Payments / wallet | `chief-payments-risk` |
| Legal / DMCA / KYC | `chief-legal-compliance` |
| Abuse / safety | `chief-trust-safety` |

❌ Skipping the correct agent = INVALID FIX.

---

### Stage 3 — SKILLS ENFORCEMENT (MANDATORY)

Agents MUST actively use relevant skills from:

.cursor/skills/

Minimum required skills per category:

#### Auth / Identity
- `better-auth-best-practices.skill.md`
- `supabase-postgres-best-practices.skill.md`

#### UI / Frontend
- `shadcn-ui.skill.md`
- `react-best-practices.skill.md`
- `frontend-design.skill.md`

#### E2E / QA
- `e2e-test-setup.skill.md`
- `fixture-generator.skill.md`
- `test-report-generator.skill.md`

#### CI / Infra
- `ci-pipeline-config.skill.md`
- `api-test-runner.skill.md`

❌ Fixes that ignore skills are considered **hallucinated**.

---

## 3. ZERO-HALLUCINATION RULE

The agent MUST NOT:
- Guess Supabase schemas
- Guess Stripe behavior
- Guess browser auth state
- Guess Playwright selectors

Instead:
- Use skills
- Use Browser tool
- Use existing code as source of truth

Unverified assumptions = HARD STOP.

---

## 4. TEST OR IT DID NOT HAPPEN

Every fix MUST include **real output**.

### Mandatory Evidence
At least one of:

```bash
pnpm type-check
pnpm lint
pnpm build
pnpm exec playwright test tests/e2e/smoke-check.spec.ts
pnpm qa:gate
```

Logs MUST be pasted or summarized with:


Passed / Failed count


Duration


Environment


❌ “Should work” is forbidden language.

5. CI EQUIVALENCE LAW
Local behavior MUST match CI behavior.
Required guarantees:


Same PORT (3000)


Same env loading strategy


Same build command


Same auth/session model


If CI fails but local passes → LOCAL IS WRONG.

6. RELEASE BLOCKERS (ABSOLUTE)
The following block push / merge:


❌ pnpm build fails


❌ Auth works in script but fails in UI (or vice versa)


❌ E2E relies on brittle selectors without testids


❌ Session works in CI but not locally


❌ “Temporarily skip” without explicit approval



7. FIX CLASSIFICATION (必须声明)
Every change MUST be tagged as one:


P0 — CI / Build / Auth / Money


P1 — UX / Flakiness / Test stability


P2 — Refactor / Cleanup


P3 — Docs / Comments


P0 fixes require:


Agent confirmation


Test proof


CI impact explanation



8. ARTIFACTS & TRACEABILITY
Every repair MUST leave traces:


Debug logs → debug.log


Reports → docs/reports/


Legacy failures → docs/archive/legacy_reports/


Silent fixes are forbidden.

9. VERSIONING & FUTURE UPGRADE
This law is versioned.
Upgrade process:


Copy this file


Increment version


Add CHANGELOG section


Never break backward rules without justification



10. FINAL GATE — CAN WE PUSH?
Before saying “ready” the agent MUST answer:


✅ Can this be pushed now?


✅ Will CI pass without manual intervention?


✅ Is local == CI == prod?


✅ Are all relevant agents & skills used?


If ANY answer is “not sure” → STOP.

🧠 Remember:
Speed is optional.
Correctness is mandatory.

---

# 🔗 如何接入你现有 rules（必须做）

在：

### `.cursor/rules/000-core-kernel.mdc`
顶部加：

```md
> This project is governed by `.cursor/release-gate.prompt.md`
> Any conflict resolves in favor of RELEASE GATE.
```

.cursor/rules/ci-quality-enforcement.mdc
加：
All CI checks are subordinate to RELEASE GATE SUPREME LAW.

## 🎯 核心原则

**每一行代码推送到 CI 前都必须通过本地质量检查!**

## ⚠️ 强制执行规则

### 1. 推送前必须运行
```bash
pnpm check-all
```

这个命令会依次执行:
- ✅ `pnpm type-check` - TypeScript 类型检查
- ✅ `pnpm lint` - ESLint 代码规范
- ✅ `pnpm format:check` - Prettier 格式检查
- ✅ `pnpm test:unit` - 单元测试
- ✅ `pnpm build` - 构建验证

### 2. 所有检查必须通过
- **0 TypeScript 错误**
- **0 ESLint 错误** (警告可接受但需评估)
- **格式符合 Prettier 规范**
- **所有单元测试通过**
- **构建成功无错误**

### 3. Git Hook 自动保护
- `.husky/pre-push` 会在每次推送前自动运行检查
- 如果检查失败,推送会被阻止
- 你会看到清晰的错误信息和修复建议

## 🚫 严格禁止的行为

### ❌ 绝对不允许
1. **跳过检查推送**
   ```bash
   git push --no-verify  # 禁止使用!
   ```

2. **推送有明显错误的代码**
   - 有 TypeScript 类型错误
   - 有 ESLint 错误
   - 构建失败
   - 测试失败

3. **在 CI 失败时合并 PR**
   - 必须等待所有 CI 检查通过
   - 必须解决 Reviewdog 评论的问题

## ✅ 正确的工作流程

### 开发阶段
```bash
# 1. 创建分支
git checkout -b feature/your-feature

# 2. 开发代码
# ... 编写代码 ...

# 3. 实时检查 (可选,但推荐)
pnpm type-check  # 边开发边检查类型
pnpm lint        # 检查代码规范
```

### 提交前检查
```bash
# 4. 完成开发后,运行完整检查
pnpm check-all

# 5. 如果有错误,修复它们
pnpm lint:fix      # 自动修复 lint 问题
pnpm format        # 自动格式化代码

# 6. 再次运行检查,确保全部通过
pnpm check-all
# 必须看到所有步骤都是 ✅
```

### 提交和推送
```bash
# 7. 提交代码
git add .
git commit -m "feat: 你的功能描述"

# 8. 推送 (pre-push hook 自动运行)
git push origin feature/your-feature
# 🚀 运行推送前检查...
# ✅ 所有检查通过! 正在推送...
```

### PR 和合并
```bash
# 9. 在 GitHub 创建 PR

# 10. 等待 CI 完成 (约 5-10 分钟)
# - ci.yml ✅
# - code-quality.yml ✅  
# - pr-auto-review.yml ✅

# 11. 查看自动反馈
# - 🏷️ 自动标签 (size/type/area)
# - 💬 Reviewdog 评论 (如果有问题)
# - 📊 质量报告
# - 🔒 安全扫描结果

# 12. 解决所有问题后合并
# 点击 "Merge pull request"
```

## 🛠️ 常见问题修复

### 问题 1: TypeScript 类型错误
```bash
# 运行检查查看详细错误
pnpm type-check

# 常见修复方式:
# - 添加正确的类型标注
# - 修复 any 类型为具体类型
# - 更新 interface/type 定义
# - 检查导入路径
```

### 问题 2: ESLint 错误
```bash
# 自动修复能修复的问题
pnpm lint:fix

# 查看剩余问题
pnpm lint

# 手动修复无法自动修复的问题
# 参考 ESLint 错误信息
```

### 问题 3: Prettier 格式问题
```bash
# 自动格式化所有文件
pnpm format

# 再次检查
pnpm format:check
```

### 问题 4: 单元测试失败
```bash
# 查看详细测试输出
pnpm test:unit

# 修复失败的测试
# 或更新测试以匹配新的实现

# 再次运行
pnpm test:unit
```

### 问题 5: 构建失败
```bash
# 检查环境变量
cp .env.example .env.local
# 填写正确的 Supabase 配置

# 清理缓存
rm -rf .next node_modules/.cache

# 重新构建
pnpm build
```

## 📊 CI 工作流说明

### 1. ci.yml - 主 CI 流水线
**触发**: Push/PR 到 main/develop

**阶段**:
1. Lint & Type Check
2. Build
3. QA Gate (UI + Dead Click)
4. E2E Tests
5. Quality Gate

**必须**: 全部通过才能合并

### 2. code-quality.yml - 代码质量
**触发**: PR 或 Push

**功能**:
- 运行所有本地检查
- Reviewdog 在 PR 上评论问题
- 生成质量报告

**特点**: 只评论新增/修改的代码

### 3. pr-auto-review.yml - 自动审查
**触发**: PR 打开/更新

**功能**:
- 自动添加标签 (size/type/area)
- TODO/FIXME 统计
- 大文件警告 (>500 行)
- 依赖安全审计
- 密钥泄露扫描
- 自动评论汇总

## 🎓 AI Agent 使用规则

### 作为 AI Agent,我必须:

1. **在修改代码后,提醒用户运行检查**
   ```
   ✅ 代码已修改完成!
   
   请运行以下命令验证:
   pnpm check-all
   ```

2. **在建议提交代码前,强调检查的重要性**
   ```
   准备提交代码前,请确保:
   1. pnpm check-all 全部通过
   2. 没有 TypeScript 错误
   3. 没有 ESLint 错误
   4. 构建成功
   ```

3. **如果用户想跳过检查,必须警告**
   ```
   ⚠️ 警告: 不建议跳过检查!
   
   跳过检查可能导致:
   - CI 失败
   - 代码质量下降
   - PR 被拒绝
   - 团队其他成员的困扰
   
   请运行 pnpm check-all 确保代码质量
   ```

4. **在创建 PR 前,提供完整的检查清单**
   ```
   创建 PR 前检查清单:
   - [ ] pnpm check-all 全部通过
   - [ ] 所有测试通过
   - [ ] 代码已格式化
   - [ ] 没有 console.log 调试代码
   - [ ] 没有 TODO/FIXME 未解决
   - [ ] 已更新相关文档
   ```

## 📚 相关文档

必读文档:
- `.github/PRE_COMMIT_CHECKLIST.md` - 提交前检查清单
- `.github/GITHUB_SECRETS_SETUP.md` - GitHub Secrets 配置
- `.github/workflows/WORKFLOW_GUIDE.md` - CI 工作流指南
- `CI_REVIEW_SETUP.md` - CI 审查系统配置
- `SETUP_COMPLETE.md` - 完整设置指南

## 🎯 质量标准

### 代码必须满足:
- ✅ 0 TypeScript 错误
- ✅ 0 ESLint 错误
- ✅ 100% 格式化
- ✅ 所有测试通过
- ✅ 构建成功
- ✅ 无安全漏洞
- ✅ 无密钥泄露

### PR 必须满足:
- ✅ 所有 CI 检查通过
- ✅ Reviewdog 评论的问题已解决
- ✅ 代码审查通过
- ✅ 有适当的测试覆盖

## 💪 记住

**质量第一,速度第二!**

宁愿多花 2 分钟运行检查,也不要花 20 分钟修复 CI 失败!

**每次推送前,问自己:**
- ✅ 我运行了 `pnpm check-all` 吗?
- ✅ 所有检查都通过了吗?
- ✅ 我的代码符合标准吗?

**如果有任何一个是 NO,就不要推送!**

---

*此规则由 CI/CD 自动化系统强制执行*
*违反规则的推送会被自动阻止*
